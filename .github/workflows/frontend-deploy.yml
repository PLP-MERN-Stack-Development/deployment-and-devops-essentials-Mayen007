name: Deploy Frontend to Render

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build & Deploy Frontend to Render
    runs-on: ubuntu-latest
    env:
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID_FRONTEND }}
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run lint
        working-directory: frontend
        run: npm run lint
        continue-on-error: true

      - name: Run tests
        working-directory: frontend
        run: npm test
        continue-on-error: true

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Check Render secrets
        run: |
          if [ -z "$RENDER_API_KEY" ]; then
            echo "RENDER_API_KEY is not set"; exit 1
          else
            echo "RENDER_API_KEY is present"
          fi
          if [ -z "$RENDER_SERVICE_ID" ]; then
            echo "RENDER_SERVICE_ID_FRONTEND is not set"; exit 1
          else
            echo "RENDER_SERVICE_ID_FRONTEND is present"
          fi

      - name: Trigger Render deploy
        id: trigger
        run: |
          set -e
          echo "Triggering frontend deploy for service $RENDER_SERVICE_ID"
          resp=$(curl -s -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d '{}')

          deploy_id=$(echo "$resp" | jq -r .id)
          if [ -z "$deploy_id" ] || [ "$deploy_id" = "null" ]; then
            echo "Failed to create deploy:" >&2
            echo "$resp" >&2
            exit 1
          fi

          echo "deploy_id=$deploy_id" >> $GITHUB_OUTPUT
          echo "Deploy triggered with ID: $deploy_id"

      - name: Wait for deploy to finish
        run: |
          set -e
          deploy_id=${{ steps.trigger.outputs.deploy_id }}
          echo "Waiting for deploy $deploy_id to complete..."

          # Poll until status is success or failed (timeout 30 minutes)
          max_seconds=1800
          interval=10
          elapsed=0
          while [ $elapsed -lt $max_seconds ]; do
            raw=$(curl -s -H "Authorization: Bearer ${RENDER_API_KEY}" "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys/${deploy_id}")
            s=$(echo "$raw" | jq -r .state)
            echo "Deploy state: $s (elapsed: ${elapsed}s)"

            if [ "$s" = "success" ]; then
              echo "✅ Frontend deployed successfully"
              break
            fi
            if [ "$s" = "failed" ]; then
              echo "❌ Frontend deploy failed" >&2
              echo "Response: $raw" >&2
              exit 1
            fi
            sleep $interval
            elapsed=$((elapsed + interval))
          done

          if [ $elapsed -ge $max_seconds ]; then
            echo "❌ Timed out waiting for deploy" >&2
            exit 1
          fi

      - name: Verify deployment
        run: |
          echo "✅ Frontend deployment completed successfully"
          echo "Frontend URL: https://deployment-and-devops-essentials-mayen007-vu4l.onrender.com/"
